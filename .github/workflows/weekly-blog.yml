name: Weekly Chess Blog

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9:00 AM UTC
  workflow_dispatch: # Manual trigger for testing

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch project data
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: bash .github/scripts/fetch-chess-data.sh

      - name: Save data for Claude
        run: cp /tmp/chess-blog-data.json ./data-current.json

      - name: Clone wiki
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/bh679/chess-project.wiki.git wiki-checkout
          cd wiki-checkout
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code@2.1.18
          CLAUDE_BIN=$(which claude)
          echo "CLAUDE_PATH=$CLAUDE_BIN" >> $GITHUB_ENV
          echo "Claude Code version: $(claude --version)"

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          path_to_claude_code_executable: ${{ env.CLAUDE_PATH }}
          prompt: |
            You are the Chess project blog writer. Your task: generate a weekly blog post
            and publish it to the chess-project wiki.

            ## Steps

            1. Read `blog/blog-post-guidelines.md` — these are the writing guidelines you MUST follow for the blog post.

            2. Read `blog/blog-index-template.md` — this is the template you MUST follow when updating the Development-Blog index page.

            3. Read `data-current.json` — this contains:
               - Project board items with statuses, priorities, categories (covers both chess-client and chess-api)
               - Recent commits from both chess-client and chess-api
               - Merged PRs from both repos
               - Closed issues
               - Previous week's state for comparison

            4. Read existing blog posts in `wiki-checkout/` (files matching `Blog:-*.md`) for style reference.

            5. Get today's date: `date -u +%Y-%m-%d`

            6. Create a new wiki page file in `wiki-checkout/`.
               - Choose a sharp, descriptive title for the blog post
               - Convert the title to a hyphenated slug (e.g. "User Accounts Are Live" → "User-Accounts-Are-Live")
               - Filename: `wiki-checkout/Blog:-<Title-Slug>.md` (e.g. `Blog:-User-Accounts-Are-Live.md`)
               - Do NOT include dates in the filename
               - Follow the blog post guidelines from step 1. Compare current data to `previous_state` to identify what changed.

            7. Update `wiki-checkout/Development-Blog.md` — add a new entry above the
               `<!-- New posts are added above this line -->` comment.
               Follow the blog index template from step 2. Format:
               ```
               ## [[Blog:-<Title-Slug>|<title>]]
               YYYY-MM-DD — Chess
               <1-2 sentence abstract>
               ```

            8. Update `blog/state.json` — overwrite with current project board snapshot:
               ```json
               {
                 "last_run": "YYYY-MM-DD",
                 "project_board_snapshot": {
                   "items": <items array from data-current.json>
                 }
               }
               ```

            9. Delete `data-current.json` (temporary file).

            10. Commit and push the wiki:
                ```bash
                cd wiki-checkout && git add -A && git commit -m "Blog: weekly chess update YYYY-MM-DD" && git push
                ```

            11. Commit and push state in the main repo:
                ```bash
                cd /home/runner/work/chess-client/chess-client && git add blog/state.json && git commit -m "blog: update state YYYY-MM-DD" && git push
                ```

          claude_args: "--max-turns 25 --allowedTools Edit,Read,Write,Bash(date:*),Bash(git:*),Bash(rm:*),Bash(cd:*),Bash(ls:*)"
